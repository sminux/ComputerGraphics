<html>
    <title>
        Third lab.
        Bezier curve
    </title>
<body>
<p>For drawing curve press 'Enter' or 'Space' button</p>
<script>
  function makeLine(ctx, x0, y0, x1, y1) 
    {
        var A = x1-x0;
        var B = y1-y0;
        var ort;
        if (Math.abs(B)<=Math.abs(A)) temp = 1;
        else ort = 0;
        var dy = 1;
        var a;
        var b;
        var xn, yn;
        if (temp) 
        {
           a = Math.abs(A); 
           b = Math.abs(B);
           if (x0<=x1) {
              xn = x0;
              yn = y0;
              if (B<0) dy=-1;
            } else {
                xn = x1;
                yn = y1;
                if (B>0) dy=-1;
            }
        } else {
           a = Math.abs(B); 
           b = Math.abs(A);
           if (y0<=y1) {
              xn = x0;
              yn = y0;
              if (A<0) dy=-1;
            } else {
               xn = x1;
               yn = y1;
               if (A>0) dy=-1;
            }
        }
        var d = 2*b-a;
        var y = 0;
        var x = 0;
        for (x=0; x<a; x++) 
        {
          if (d>=0) 
          {
            y += dy;
            d += 2*(b-a);
          } else {
            d += 2*b;
          }
          if (temp) ctx.fillRect(x+xn, y+yn, 1, 1);
          else ctx.fillRect(y+xn, x+yn, 1, 1);
        }
  }
    
  class Point {
    Point(x, y) 
      {
          this.x = x;
          this.y = y;
      }
  }
    
  function drawCurve(ctx, points) {
    var t = 0.5;
    var lp = [];
    var rp = [];
    var np = [];
    var rnp = [];
    var mp = [];//middle
    mkPoints(points, lp, rp);
    
    for (var i = 0; i < points.length-1; i++) 
    {
        let point = new Point((points[i].x+points[i+1].x)/2, (points[i].y+points[i+1].y)/2);
        mp.push(point);
    }
    let p = new Point((points[0].x+2*points[1].x+points[2].x)/4,(points[0].y+2*points[1].y+points[2].y)/4);
    np.push(points[0]);
    np.push(mp[0]);
    np.push(p);
    rnp.push(p);
    rnp.push(mp[1]);
    rnp.push(points[2]);

    var lsize = lp.length;
    var rsize = rp.length;
    var a = lp[lsize-1].x-lp[0].x;
    var b = lp[lsize-1].y-lp[0].y;
    var lflag = 1;
    for (i=1; i<lsize-1; i++) 
    {
      if (b/a*(lp[i].x-lp[0].x)+lp[0].y-lp[i].y >=1 ) lflag = 0;
    }
    if (!lflag)
    {
	   drawCurve(ctx, lp);
    } else {
       makeLine(ctx, lp[0].x, lp[0].y, lp[lp.length-1].x, lp[lp.length-1].y);
    }
    var a1 = points[2].x-p.x;
    var b1 = points[2].y-p.y;
    if (b1/a1*(mp[1].x-points[2].x) + points[2].y - mp[1].y >= 1) 
    {
	   drawCurve(ctx, rp);
    } else {
      makeLine(ctx, rp[0].x, rp[0].y, rp[rp.length-1].x, rp[rp.length-1].y);
    }
  }
  function mkPoints(p, lp, rp) 
    {
        if (p.length == 2) 
        {
            var n_p = new Point((p[0].x+p[1].x)/2, (p[0].y+p[1].y)/2);
            lp.push(p[0]);
            rp.push(p[1]);
            lp.push(n_p); 
            rp.push(n_p);
            return;
        }
        lp.push(p[0]);
        rp.push(p[p.length-1]);
        var tmpoints = [];
        for (var i = 0; i < p.length-1; i++) 
        {
            var new_p = new Point((p[i].x+p[i+1].x)/2, (p[i].y+p[i+1].y)/2);
            tmpoints.push(new_p);
        }
        mkPoints(tmpoints, lp, rp);
    }

  
</script>
<canvas id='lab_3' width='1200' height='1200'>
  <script>
    var canvas = document.getElementById('lab_3');
    var ctx = canvas.getContext('2d');
    var p = [];
    var k = 0;
    
    function onClick()
    {
        if (event.button == 0) 
        {
            var x = event.offsetX;
            var y = event.offsetY;
            let point = new Point(x, y);
            p.push(point);
            k++;
            if(k > 1) makeLine (ctx, p[k-1].x, p[k-1].y, p[k].x, p[k].y)
            ctx.fillRect(point.x, point.y, 1, 1);
        } 
    }
      
    function check(e) 
    {
        if(( e.keyCode == 13)||( e.keyCode == 32))
        {          
           drawCurve(ctx, p);
        }   
    }
      
    canvas.addEventListener('click', onClick);
    window.addEventListener('keydown',this.check,false);
  </script>
</canvas>

</body>
</html>